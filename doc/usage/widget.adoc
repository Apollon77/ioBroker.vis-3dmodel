= 3D Model Widget
The widget itself can be used like any regular widget in iobroker VIS. It should look similar to the following figure:

image:media/3dmodel_widget_vis_main.png[title="Main view 3D Model Widget VIS",800]

To work properly, a valid GLTF file needs to be uploaded to ioBroker VIS file manager (`Setup` â†’ `File Manager...`) and referenced in the widget attributes under `General` / `Common` / `*gltf file*`.

[TIP]
====
If a exported GLTF file is valid, can be checked easily beforehand with available online tools, like link:https://gltf-viewer.donmccurdy.com/[GLTF Viewer].
====

== Model
[.float-group]
--
image:media/3dmodel_widget_vis_settings_model.png[Widget settings - Model,300,float="right"]
The following settings are available to position and size the model properly to the viewport:

* `*scene*`: Every GLTF file should contain at least one scene containing meshes, lights and animations. Scenes in ThreeJS eqaul scenes used in Blender. In the smarthome context scenes can be used to keep data from different floors (or even rooms) separated, but still in the same model.
* `*model position x/y/z*`:  Position of the model on each axis in 3D space. Setting `0` here is sufficient for most scenarios.
* `*scaling*`: This setting allows you to scale your model up or down. A similar effect can be achieved by changing the camera settings which is more complex, so this setting here is mostly there for conveniance. While the scrollbar allows the model to be scaled up to 10 times of its original size, the input box can be used to scale even higher than that.
* `*background-color*`: The default two-dimensional background color for the rendered model can be set here.
--

== Camera
In this widget the camera always orbits around a target (aka your model), which allows for a free 360 degree rotation into every direction of 3D space. 

[.float-group]
--
image:media/3dmodel_widget_vis_settings_camera.png[Widget settings - Camera,300,float="right"]

* `*camera target position (x/y/z)*`: As you normally want the camera to exactly rotate around your model, it is advised to use the same settings here as for `Model` / `model position x/y/z`.
* `*camera position (x/y/z)*`: This is starting position of your camera "in orbit" and given distance and angle to `camera target position` decides what users will see from your model when loading the page initially. Once the widget is fully loaded, by dragging or scrolling you can change the camera position in real-time to inspect different parts of your model.
--

== Lighting
Lighting is a key feature in this widget to propery illuminate the loaded 3D model.

[.float-group]
--
image:media/3dmodel_widget_vis_settings_lighting.png[Widget settings - Lighting,300,float="right"]

* `*realisic lighting*`: Enables more realistic, physically correct, but more cpu intensive lighting. See also link:https://threejs.org/docs/#api/en/renderers/WebGLRenderer.physicallyCorrectLights[ThreeJS docs].
* `*ambient lighting*`: Globally illuminate the whole scene equally. See also link:https://threejs.org/docs/#api/en/lights/AmbientLight[ThreeJS docs].
* `*ambient color*`: Color of ambient lighting.
* `*ambient intensity*`: Intensity of ambient light. In physically correct mode, intensity is interpreted as luminous intensity measured in candela.
* `*calculate shadows*`: If activated, all objects in the scene will cast and receive shadows.
* `*number of switchable lights*`: Number of lights that should be bound to ioBroker states. Opens up new submenues. See chapter link:#_switchable_lights[Switchable Lights].
--

=== Switchable Lights
Besides permanent light sources, it is also possible to configure switchable lights which can be bound to IoBroker states.

[.float-group]
--
image:media/3dmodel_widget_vis_settings_switchable_lights.png[Widget settings - Switchable Lights,300,float="right"]

* `*light_name*`: Light object from 3D model that should be linked to state. For punctual lights the GLTF format supports Directional, Point and Spot lights.
* `*monitored_state*`: ioBroker state to bind light to.
* `*light_max_power*`: Light intensity/brightness. In physically correct mode, intensity is interpreted as luminous intensity measured in candela.

TODO: Light behaviour in connection with ioBroker state
--

== Clickable Objects
Apart from binding link:#_animations[Animations] and link:#_switchable_lights[Lights] to states, it is also possible to make every object in the scene clickable. Once clicked upon, a customly configured action (e.g. execution of Javascript) will be invoked.

[WARNING]
--
Not fully implemented yet
--

[.float-group]
--
image:media/3dmodel_widget_vis_settings_clickable_objects_1.png[Widget settings - Clickable Objects 1,300,float="right"]

* `*highlight selection*`: Highlight selected objects in 3D view. If a mouse is used to interact with the 3D model, objects will be highlighted already on mouse over, otherwise only when clicking on them.
* `*highlight color*`: Color of the highlighting-effect applied to objects.
* `*number of clickable objects*`: Number of objects in model that should be clickable. Opens up new submenues for configuration.

--
[.float-group]
--
Each clickable object can be configured as follows:
image:media/3dmodel_widget_vis_settings_clickable_objects_2.png[Widget settings - Clickable Objects 2,300,float="right"]

* `*object name*`: Name of the clickable object.
* `*clickable_object_action_id*`: *Does nothing at the moment.*
* `*clickable_object_action_task*`: *Does nothing at the moment.* The idea is to have options like: 
** run JavaScript
** set the monitored state to a preconfigured value
** open up new preconfigured dialog window (e.g. dialog with slider for window blinds)

--



== Animations
The animation system within this widget is rather complex and based on the ThreeJS library. Please also take the link:https://threejs.org/docs/#manual/en/introduction/Animation-system[ThreeJS Animation System documentation] into account when working with animations.

[.float-group]
--
image:media/3dmodel_widget_vis_settings_animations_1.png[Widget settings - Animations 1,300,float="right"]

* `*number of animations*`: Number of animations to configure. Opens up new submenues.

--

Each animation can be configured as follows:
[.float-group]
--
image:media/3dmodel_widget_vis_settings_animations_2.png[Widget settings - Animations2,300,float="right"]

* `*behaviour*`: Decides under which conditions the animation is played:
** `monitor state`: Plays the animation in sync with a ioBroker state.
** `auto play`: Plays the animation as soon as the model is loaded.
* `*monitored state*`: ioBroker state to bind animation to.
* `*animation*`: Animation for which this configuration applies.
* `*repeat*`: Loop the animation, instead of playing it just once. Mostly used in conjunction with `auto play`.
* `*state max value*`: Max value the ioBroker state can have. This value is used, when the ioBroker state referred to is of type _number_ (not _boolean_!). The widget then assumes that the state can be set to a value from 0 to `state max value`. Defaults to _100_. See further explanation below.

--

When *Animations* are turned on, they will just play once, unless configured to _repeat_. Typical smarthome scenarios could be opened/closed doors, windows, or other devices that can be toggled.

With a configured `state max value` (the highest value the monitored state can have) it is calculated relatively, up to which point an animation is played. E.g. a window-blind animation is played up to 50%, if the state value indicates the blinds are closed that much (e.g. current state value: 50, state max value: 100). If the state value decreases after that (e.g. because blinds are opened more and only 30% closed) the animation will play in reverse up to that percentage.

== Debugging

[WARNING]
--
Further debugging features have not yet been implemented.
--
